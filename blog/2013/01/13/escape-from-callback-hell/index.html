
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Escape from Callback Hell - Ian Bishop</title>
	<meta name="author" content="Ian Bishop">

	
	<meta name="description" content="Brief Intro In 2009, I was working as a student for a small consulting firm, tasked to develop some real-time visualization stuff for the web. &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Ian Bishop" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">Ian Bishop</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:ianbishop.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/ianbishop" title="Twitter">Twitter</a>
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:ianbishop.github.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Escape From Callback Hell</h2>
	<div class="entry-content"><p><img src="http://i.imgur.com/KCquBAn.jpg" alt="Be this guy." /></p>

<h2>Brief Intro</h2>

<p>In 2009, I was working as a student for a small consulting firm, tasked to develop some real-time visualization stuff for the web.</p>

<p>Normally, this would have meant writing some Flash. But it was 2009, so <em>Flash Is Dead</em> and <em>HTML5 Is King</em>.</p>

<p>It was the first project I would work on where Javascript would make up the meat of the work, rather than just &#8220;sprinkling some jQuery on it&#8221; &#8211; another thing people said back then.</p>

<p>Over the next 8 months, I travelled down the path of re-learning Javascript. It&#8217;s likely a path many of you are familiar with.</p>

<p>At first, I tried to make everything object-oriented. Then, oh god, so much global state. I sat there, puzzled, googling desperately:</p>

<p><img src="http://i.imgur.com/4ZiXUqN.png" alt="Don't be this guy." /></p>

<p>I eventually realized that I was among the many who never became familiar with the slumbering beast in our browsers, soon to be awoken to bring on the next generation of the web.</p>

<p>Despite this enlightenment, something kept coming back to haunt every project I worked on. See, the difficulty was not using the new shiny HTML5 canvas APIs to draw spinning circles, but rather, it was this pesky <em>AJAX</em> thing.</p>

<p>Infact, it was the <strong><em>A</em></strong> in particlar.</p>

<h2>A (for Asynchronous)</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">getItem</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/item/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is genuinely how I expected things would work.</p>

<p>But it isn&#8217;t. Instead, we have <em>callbacks</em>. Mysterious functions which are called when our request completes (if ever) and passes the resulting data as arguments.</p>

<p>That doesn&#8217;t sound bad at all.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">displayItem</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">loadItem</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/item/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">displayItem</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Callback Hell</h3>

<p><a href="http://callbackhell.com/">Callback Hell</a> is the affectionate name given to what happens when you want to do a bunch of sequential things using these asynchronous functions.</p>

<p>Let&#8217;s use <a href="http://developer.echonest.com/docs/v4/">The Echo Nest</a> as our guinea pig. These guys are really cool and let you upload songs to be analyzed. With their analysis, you can create some <a href="http://drinkify.org/">really effing</a> <a href="http://labs.echonest.com/Uploader/index.html">amazing stuff</a>.</p>

<p>But that doesn&#8217;t necessarily look that cool or read that cool.</p>

<figure class='code'><figcaption><span>Remix.js</span><a href='https://github.com/echonest/remix.js/blob/master/remix.js'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">trackID</span><span class="p">,</span> <span class="nx">api_key</span><span class="o">:</span><span class="nx">apiKey</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">analysisURL</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">track</span><span class="p">.</span><span class="nx">audio_summary</span><span class="p">.</span><span class="nx">analysis_url</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">track</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">track</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This call is proxied through the yahoo query engine.</span>
</span><span class='line'>    <span class="c1">// This is temporary, but works.</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s2">&quot;http://query.yahooapis.com/v1/public/yql&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span> <span class="nx">q</span><span class="o">:</span> <span class="s2">&quot;select * from json where url=\&quot;&quot;</span> <span class="o">+</span> <span class="nx">analysisURL</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">,</span> <span class="nx">format</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">},</span>
</span><span class='line'>      <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">results</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">track</span><span class="p">.</span><span class="nx">analysis</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">json</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">remixer</span><span class="p">.</span><span class="nx">remixTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">,</span> <span class="nx">trackURL</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;No analysis data returned:  sorry!&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything is fun and games until you have callbacks calling callbacks calling callb&#8230;<a href="http://www.youtube.com/watch?v=s8S5PN1FnFk&amp;t=1m29s">backs on backs on backs</a>.</p>

<h3>Deferral</h3>

<p>Luckily, the Javascript community is filled with <a href="https://twitter.com/rmurphey">smart</a>, <a href="https://twitter.com/jaubourg">hardworking</a> people who make tools to fix these problems. In 2011, <a href="http://yayquery.com/">a group of people whom I respect dearly</a> were really excited to talk about how the antidote had arrived.</p>

<p>Our Virgil is here, ready to guide us out of this place, and his name is <a href="https://github.com/jquery/jquery/commit/116c82b027a03a7a5670fa580fa9af819cc1cc03">$.Deferred</a>.</p>

<h2>Breaking It Down</h2>

<p>Promises are by no means a new idea. They were invented <a href="http://en.wikipedia.org/wiki/Futures_and_promises">back in the 1970s</a> by some really smart guys who were trying to figure out how to write programs that did more than one thing at a time. Even though Javascript is single threaded, promises prove to be extrodinarily useful for managing asynchronous calls.</p>

<p>A promise is like saying that you&#8217;re doing something and you don&#8217;t know how long it will take but, when you&#8217;re done, you promise you&#8217;ll do some other stuff. In reality, it&#8217;s much like me promising that I will remember to pick up some milk after work, except computers don&#8217;t break promises.</p>

<h3>Fulfilling a Promise</h3>

<figure class='code'><figcaption><span>Creating a Deferred Object</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createAPromise</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, making a promise is pretty easy. Especially one like this, which doesn&#8217;t do anything.</p>

<figure class='code'><figcaption><span>An (Updated) Example from Rebecca Murphey&#8217;s &#8220;Deferreds Coming to jQuery 1.5?&#8221;</span><a href='http://rmurphey.com/blog/2010/12/25/deferreds-coming-to-jquery/'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">doIt</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span> <span class="mi">5000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, we can see that we now actually doing something asynchronous, namely waiting for 5s.</p>

<p>The key though is that, once we&#8217;re done waiting, we&#8217;re going to call <code>dfd.resolve('hello world')</code>.</p>

<p>By resolving the deferred object, we are fulfilling the promise we made. We can also use <code>reject</code> to say that we failed to fulfill the promise (computers sometimes forget to pick up milk, after all). Finally, we can also use <code>notify</code> to inform everyone how we are progressing.</p>

<h3>Everything is Already a Promise</h3>

<p>Anything that is done asychronously in jQuery is already re-written to return a promise.</p>

<figure class='code'><figcaption><span>Circa 2009 Looking Code</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/api/item&quot;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I used to write stuff like this a lot.</p>

<p>Now you might be seeing stuff that looks a bit more like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">successCallback</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/api/item&quot;</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">req</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">successCallback</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">req</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">errorCallback</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is better, it definitely makes it clearer what exactly is going on. The only magic here is what are these <code>success</code> and <code>error</code> things? It turns out that they are actually just deferreds.</p>

<h3>Chaining Things Together</h3>

<figure class='code'><figcaption><span>Simple Chaining</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">displayError</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR! &quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">displayItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">getItem</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/item/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">getItem</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">displayItem</span><span class="p">,</span> <span class="nx">displayError</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this simple example, we can see that we are going to try and an item with <code>id = 5</code> and then either log the data (on success) or complain about errors (on error).</p>

<h3>Working in Parallel</h3>

<p>Let&#8217;s say that you have a couple things you want to do at the same time and then maybe when they are both done you want to do something else.</p>

<figure class='code'><figcaption><span>Parallel using $.when</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">getItem</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/item/&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">getItem</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nx">getItem</span><span class="p">(</span><span class="mi">4</span><span class="p">)).</span><span class="nx">then</span><span class="p">(</span><span class="nx">handleSuccess</span><span class="p">,</span> <span class="nx">handleFailure</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>$.when</code> will create a wrapper deferred that tracks the results of each deferred. If any of the promises fail, it will call <code>reject</code> on the master promise, otherwise it will call <code>resolve</code>.</p>

<p>There are many more functions at your disposal, check out the <a href="http://api.jquery.com/category/deferred-object/">$.Deferred documentation</a> for more information.</p>

<h2 id="cookbook">Cooking with Deferreds</h2>


<h3>Wait</h3>

<p>I really like this helper function as it allows you to do deferred waits when you&#8217;re doing stuff like long polling. I&#8217;m not sure who the credit for this belongs to, it might have been from an SO post or maybe I wrote it myself. If you know, please leave a comment with its source.</p>

<figure class='code'><figcaption><span>Wait</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">wait</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">dfd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="mi">5000</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">doSomething</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Polling for Change</h3>

<p>Sometimes you will have to do some polling, waiting to see if a delayed job has completed.</p>

<p>The Echo Nest is a good example of this &#8211; uploading a file, waiting for it to be analyzed and then getting that analysis when it&#8217;s done.</p>

<figure class='code'><figcaption><span>Long Polling for Change</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">checkTrackStatus</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;http://developer.echonest.com/api/v4/track/profile?format=json&amp;bucket=audio_summary&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">{</span> <span class="s1">&#39;api_key&#39;</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">apiKey</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">trackId</span> <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">checkTrackAnalyzed</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">checkTrackStatus</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">][</span><span class="s2">&quot;track&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="s2">&quot;complete&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="s2">&quot;pending&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">wait</span><span class="p">(</span><span class="mi">2000</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">checkTrackStatus</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">attemptAnalyze</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">uploadTrack</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">checkTrackAnalyzed</span><span class="p">,</span> <span class="nx">displayFailedToUpload</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Progress</h3>

<p>In some situations, you might have the opportunity to provide feedback to the user on how something is doing. <code>.notify</code> makes this easy.</p>

<figure class='code'><figcaption><span>Progress with notify</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">displayTrackLoading</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TRACK LOADED, REMIXIN&#39;&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TRACK LOADING: &quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">loadTrack</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">dfd</span><span class="p">.</span><span class="nx">progress</span><span class="p">(</span><span class="nx">displayTrackLoading</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">r</span><span class="p">.</span><span class="nx">remixer</span><span class="p">.</span><span class="nx">remixTrackById</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">trackId</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">trackUrl</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dfd</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">))</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Asynchronous Native Functions</h3>

<p>There is some stuff in Javascript that are done asynchronously as well. We can reduce the number of brain cycles spent on serializing a file.</p>

<figure class='code'><figcaption><span>Serializing files</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">serializeFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">dfd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dfd</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">name</span><span class="o">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">data</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">raw</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">dfd</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s pretty cool, but let&#8217;s spice it up and grab a couple files at once.</p>

<figure class='code'><figcaption><span>Serializing multiple files</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">serializeFile</span><span class="p">(</span><span class="nx">file1</span><span class="p">),</span> <span class="nx">serializeFile</span><span class="p">(</span><span class="nx">file2</span><span class="p">))</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">encodedFile1</span><span class="p">,</span> <span class="nx">encodedFile2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;File 1: &quot;</span> <span class="o">+</span> <span class="nx">encodedFile1</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;File 2: &quot;</span> <span class="o">+</span> <span class="nx">encodedFile2</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-01-13T12:52:00-04:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/deferreds/'>Deferreds</a>, <a class='category' href='/blog/categories/jquery/'>jQuery</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Ian Bishop

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-38977604-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>